<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Django过滤器 - 肖郎的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="使用Django模板需要两个工具，一个是模板标签，另一个就是过滤器。过滤器使用方式类似于管道，如:datetime|localtime:&amp;quot;arg&amp;quot;。Django两种过滤器：内置的和自定义的。">
<meta property="og:type" content="article">
<meta property="og:title" content="Django过滤器">
<meta property="og:url" content="http://shawlang.github.io/2015/08/15/Django过滤器/index.html">
<meta property="og:site_name" content="肖郎的博客">
<meta property="og:description" content="使用Django模板需要两个工具，一个是模板标签，另一个就是过滤器。过滤器使用方式类似于管道，如:datetime|localtime:&amp;quot;arg&amp;quot;。Django两种过滤器：内置的和自定义的。">
<meta property="og:image" content="http://www.designerspics.com/wp-content/uploads/2015/08/evening_tea__free_photo.jpg">
<meta property="og:updated_time" content="2015-08-16T18:00:36.811Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Django过滤器">
<meta name="twitter:description" content="使用Django模板需要两个工具，一个是模板标签，另一个就是过滤器。过滤器使用方式类似于管道，如:datetime|localtime:&amp;quot;arg&amp;quot;。Django两种过滤器：内置的和自定义的。">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="/webfonts/ptserif/main.css" rel='stylesheet' type='text/css'>
  <link href="/webfonts/source-code-pro/main.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>
<body>
  <div id="container">
    <header id="header">
  <div id="header-outer" class="outer">
    <div id="header-inner" class="inner">
      <a id="main-nav-toggle" class="nav-icon"></a>
      <a id="logo" class="logo" href="/"></a>
      <nav id="main-nav">
        
          <a class="main-nav-link" href="/">首页</a>
        
          <a class="main-nav-link" href="/archives">存档</a>
        
          <a class="main-nav-link" href="/categories">分类</a>
        
          <a class="main-nav-link" href="/tags">标签</a>
        
          <a class="main-nav-link" href="/about">关于</a>
        
          <a class="main-nav-link" href="/sideproject">个人项目</a>
        
      </nav>
      <nav id="sub-nav">
        <div id="search-form-wrap">
          <input type="text" class="st-default-search-input" />
        </div>
      </nav>
    </div>
  </div>
</header>
    <section id="main" class="outer"><article id="post-Django过滤器" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Django过滤器
    </h1>
  

      </header>
    
    <div class="article-meta">
      <a href="/2015/08/15/Django过滤器/" class="article-date">
  <time datetime="2015-08-15T10:46:37.000Z" itemprop="datePublished">2015-08-15</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/Django/">Django</a><span>></span><a class="article-category-link" href="/categories/Django/Django过滤器/">Django过滤器</a>
  </div>

      
        <div class="article-comment-link-wrap">
          <a href="http://shawlang.github.io/2015/08/15/Django过滤器/#disqus_thread" class="article-comment-link">评论</a>
        </div>
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="http://www.designerspics.com/wp-content/uploads/2015/08/evening_tea__free_photo.jpg" alt="白色的小桶"></p>
<p>使用Django模板需要两个工具，一个是模板标签，另一个就是过滤器。过滤器使用方式类似于管道，如:<code>datetime|localtime:&quot;arg&quot;</code>。Django两种过滤器：内置的和自定义的。</p>
<a id="more"></a>
<h3 id="一、内置的过滤器（built-in）">一、内置的过滤器（built-in）</h3><p>这里是Django内置过滤器官方文档列表：<a href="https://docs.djangoproject.com/en/1.8/ref/templates/builtins/#built-in-filter-reference" target="_blank" rel="external">https://docs.djangoproject.com/en/1.8/ref/templates/builtins/#built-in-filter-reference</a></p>
<p>在此列举几个：</p>
<h6 id="设置默认值">设置默认值</h6><blockquote>
<p>value|default:”nothing here”<br>  如果value值为空，value值就被默认设置为<code>nothing here</code></p>
</blockquote>
<h6 id="设置日期显示方式">设置日期显示方式</h6><blockquote>
<p>value|date:”Y m d D”<br>  2015 08 15 Sat</p>
</blockquote>
<h6 id="按照keyword进行排序">按照keyword进行排序</h6><blockquote>
<p>value|dictsort:”age”<br>  value=[{“age”:43},{“age”:54},{“age”:32}]<br>  输出后：value=[{‘age’:32,’age’:43,’age’:54}]</p>
</blockquote>
<h3 id="二、自定义过滤器（custom）">二、自定义过滤器（custom）</h3><h6 id="自定义的流程">自定义的流程</h6><p>1.在需要自定义过滤器的app下，建立一个<code>templatestag</code>文件夹，并建立<code>__in__.py</code>文件进行初始化。</p>
<p>2.在<code>templatestag</code>文件夹下过滤器文件，如<code>addName.py</code>，当导入需要这个过滤器的模板文件的时候就使用这个文件名。如<code>load addName</code></p>
<p>3.打开<code>addName.py</code>，进行代码编写。主要有三个步骤：导入<code>template</code>类，生成注册实例对象；编写过滤器函数；使用注册实例对象对自定义的过滤器注册。</p>
<pre><code><span class="keyword">from</span> django <span class="keyword">import</span> template 
register=template.Library()

<span class="function"><span class="keyword">def</span> <span class="title">addFamilyName</span><span class="params">(value,arg)</span>:</span>
    <span class="keyword">return</span> str(value)+<span class="string">" "</span>+str(arg)

register.filter(<span class="string">'addFamilyName'</span>,addFamilyName)
<span class="comment">#register.filter([name],[function object]) </span>
<span class="comment"># 前面是过滤器名字，后面是函数对象。名字如果省掉，默认的就是函数名。</span>

这里可以使用python装饰器，简写过滤器函数
<span class="decorator">@register.filter(name="addFamilyName")</span>
<span class="function"><span class="keyword">def</span> <span class="title">addFamilyName</span><span class="params">(value,arg)</span>:</span>
    <span class="keyword">return</span> value+<span class="string">" "</span>+arg

如果不设置过滤器的名字的话，可以这样写：
<span class="decorator">@register.filter</span>
<span class="function"><span class="keyword">def</span> <span class="title">addFamilyName</span><span class="params">(value,arg)</span>:</span>
    <span class="keyword">return</span> value+<span class="string">" "</span>+arg
</code></pre><h6 id="使用方法">使用方法</h6><ol>
<li>在所需要的模板中引入：如<code>load addName</code></li>
<li>在需要使用的模板标签中使用：如 <code>givenName|addFamilyName:&#39;Larry&#39;</code>。</li>
</ol>
<p><strong> 注意给过滤器传参数的格式。如addFamilyName，它的第一个参数实际上是givenName,也就是管道符号（|）前面的值；第二个参数是“Larry”，是过滤器函数需要的第二个参数，传递的格式是冒号加实际值，如果没有可以不传。</strong></p>
<h3 id="三、3个很有用的装饰器参数">三、3个很有用的装饰器参数</h3><p>1.时区转换装饰器（timezone）</p>
<pre><code><span class="decorator">@register.filter(expects_localtime=True)</span>
<span class="function"><span class="keyword">def</span> <span class="title">pub_time</span><span class="params">(value)</span>:</span>
   <span class="keyword">try</span>:
       <span class="keyword">return</span> value.hour+<span class="string">u'小时前'</span>
   <span class="keyword">except</span> AttributeError:
       <span class="keyword">return</span> <span class="string">'属性错误'</span>
<span class="comment">#把expects_localtime设置为true，Django将会把其他时间转化为本地时间    </span>
</code></pre><p>2.将参数值自动变为字符串</p>
<pre><code><span class="keyword">from</span> django <span class="keyword">import</span> <span class="keyword">template</span>
<span class="keyword">from</span> django.<span class="keyword">template</span>.defaultfilters <span class="keyword">import</span> stringfilter
register=<span class="keyword">template</span>.<span class="type">Library</span>()

@register.filter
@stringfilter
def salary(value):
   <span class="keyword">return</span> value+u.<span class="string">"千元"</span>
<span class="comment"># 这里就不用把value写成 str(value)了。</span>
<span class="comment"># 如果没有加@stringfilter，就会报错，因为数字不能喝字符串直接连接。</span>
</code></pre><p>3.将对输出的字符串进行转义。</p>
<blockquote>
<p>输出的字符串有3种：<br>  1) raw strings：原始的字符串或者unicode字符串<br>  2) safe strings：已经确定为安全的字符串，不需要转义。如想显示原生的HTML代码<br>  3) strings marked as “needing escaping”：已标记为需要转义的字符串</p>
</blockquote>
<p>Django默认的内置过滤器<code>autoescape=True</code>，即把所有的模板变量都进行转义。这样是为了防止跨站攻击。如果不需要转义可以设置<code>is_safe=True</code>。</p>
<pre><code><span class="decorator">@register.filter(is_safe=True)</span>
<span class="function"><span class="keyword">def</span> <span class="title">addFamilyName</span><span class="params">(value)</span>:</span>
    <span class="keyword">return</span> <span class="string">"%s David"</span> % value
<span class="comment">#注意：如果 设置了 is_safe 所有的输出结果为字符串类型，甚至布尔类型如True也会被转化为字符串的"True"。</span>
</code></pre><h6 id="如何进行手动禁止字符进一步转义">如何进行手动禁止字符进一步转义</h6><blockquote>
<p>使用mark_safe函数</p>
</blockquote>
<pre><code><span class="keyword">from</span> django <span class="keyword">import</span> <span class="keyword">template</span>
<span class="keyword">from</span> django.utils.safestring <span class="keyword">import</span> mark_safe
register=<span class="keyword">template</span>.<span class="type">Library</span>()

@register.filter
def addName(value):
    text=<span class="string">"&lt;strong&gt;%s&lt;/strong&gt;"</span> % value
    <span class="keyword">return</span> mark_safe(text)

<span class="comment"># text里面的html标签就不会被转义</span>
</code></pre><p>禁止字符串进一步转义还有其他3种方法：<br>1)使用内置的过滤器，如<code>value|safe</code>。这样value值就不会被转义<br>2)使用模板标签，如<code>autoescape off</code><br>3)利用的Context类的autoescape属性进行设置，如Context({‘name’:’larry’},autoescape=context.autoescape)。但是优先级没有前面两种高。</p>
<h6 id="如何手动控制字符串是否需要转义">如何手动控制字符串是否需要转义</h6><blockquote>
<p>使用needs_autoescape=True和conditional_escape类</p>
</blockquote>
<pre><code><span class="keyword">from</span> django <span class="keyword">import</span> <span class="keyword">template</span>
<span class="keyword">from</span> django.utils.html <span class="keyword">import</span> conditional_escape
register=<span class="keyword">template</span>.<span class="type">Library</span>()

@register.filter(needs_autoescape=<span class="type">True</span>) 
def addName(name,autoescape=<span class="type">True</span>):  
<span class="comment">#注意这里autoescape=True是默认值，当没有autoescape没有设置值的时候，取默认值。因为系统默认autoescape=True 所以建议给autoescape=False</span>
    <span class="keyword">if</span> autoescape:
        esc=conditional_escape
    <span class="keyword">else</span>:
        esc=lambda x:x 
        <span class="comment">#当autoescape=False可以自行设置转义成什么样，这里利用匿名函数返回原值</span>
    text=esc(name) 
    <span class="comment">#这里先生成一个转义对象实例，然后再集中对所需要的值进行转义。</span>
    <span class="keyword">return</span> text
</code></pre><h6 id="让有些字符转义，让有些字符不转义">让有些字符转义，让有些字符不转义</h6><pre><code><span class="keyword">from</span> django <span class="keyword">import</span> <span class="keyword">template</span>
<span class="keyword">from</span> django.utils.html <span class="keyword">import</span> conditional_escape
<span class="keyword">from</span> django.utils.safestring <span class="keyword">import</span> mark_safe
register=<span class="keyword">template</span>.<span class="type">Library</span>()

@register.filter(needsautoescape=<span class="type">True</span>)
def addName(name,autoescape=<span class="type">True</span>):
    <span class="keyword">if</span> autoescape:
        esc=conditional_escape
    <span class="keyword">else</span>:
        esc=lambda x:x
    <span class="literal">result</span>=<span class="string">"&lt;strong&gt;%s&lt;/strong&gt;"</span> % esc(name)
    <span class="keyword">return</span> mark_safe(<span class="literal">result</span>) 

<span class="comment">#注意：当needsautoescape设置为True，Django会自动把系统默认的autoescape的状态发送给过滤器函数addName的。在addName函数中autoescape=True这只是默认值。</span>
</code></pre><p> 为什么会有 needsautoescape这个属性呢？因为一个商业项目中，有很多人协作，模板的作者有很多，代码也有很多。虽然系统默认的autoescape为True，但是别人也有可能设置为False了。这样可以利用needsautoescape的属性检测出来。</p>
<h3 id="四、总结">四、总结</h3><p>过滤器算是处理模板的一个辅助工具。设置起来也不复杂。</p>

      
    </div>
  
    <footer class="article-footer">
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Django/">Django</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Django过滤器/">Django过滤器</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Python/">Python</a></li></ul>

    </footer>
  
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2015/08/16/把UTC时间转换为本地时间的2种方法/" id="article-nav-newer" class="article-nav-link-wrap">
      <div class="article-nav-title"><span>&lt;</span>&nbsp;
        
          UTC时间和本地时间互转的2种方法
        
      </div>
    </a>
  
  
    <a href="/2015/08/14/Django自定义中间件/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Django自定义中间件&nbsp;<span>&gt;</span></div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
</section>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2015 shawlang&nbsp;
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, theme by <a href="http://github.com/ppoffice">PPOffice</a>
    </div>
  </div>

</footer>
<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install','hpwehiRPuuBriefhgg56','2.0.0');
</script>
    
<script>
  var disqus_developer=1;
  var disqus_shortname = 'shawlang';
  
  var disqus_url = 'http://shawlang.github.io/2015/08/15/Django过滤器/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="/js/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>